# Changetext 密钥生成与管理指南

> 适用于 `patch-service/server` 服务（Express）

## 1. 前置条件

1. 服务已部署并运行（默认端口 **3008**，可通过环境变量 `PORT` 覆盖）。
2. 管理员口令 `ADMIN_SECRET` 已在服务器环境变量或源码中配置。
   * **强烈建议**：部署时改成只有你知道的随机字符串，并使用环境变量注入，例如：
     ```bash
     export ADMIN_SECRET="u7eP0vAq#2f..."
     ```
3. 服务器防火墙已放行服务端口（如 3008）。

## 2. 接口说明

| 路径 | 方法 | 描述 |
|------|------|------|
| `/admin/new` | GET | 生成密钥 |

### 2.1 请求参数

| 参数 | 必填 | 示例值 | 说明 |
|------|------|--------|------|
| `token` | 是 | `ADMIN123` | 管理员口令 `ADMIN_SECRET`，用于防止滥用 |
| `type`  | 是 | `D` / `O` / `N5` | 密钥类型（见下表） |
| `date`  | 否 | `20250621` | 指定日期（仅 `type=D` 时必填） |

#### `type` 参数详解

| 类型 | 说明 |
|------|------|
| `D`  | 指定日期密钥。结合 `date` 生成，仅在该日期使用一次。例如 `D-20250621-xxxx-xxxx` |
| `O`  | One-Time，一次性立即生效的密钥，不与日期绑定。|
| `Nn` | N-Day，有效期 `n` 天。例如 `N3` 表示 3 天有效。|

> ⚠️ 如在代码中需要更多维度的限制（次数 / IP / 失效时间等），可自行扩展 `makeKey()` 与验证逻辑。

### 2.2 返回值

成功时：纯文本密钥，如
```
D-20250621-abcd-1a2b3c4d
```
失败时：HTTP 401（口令错误）或 400（参数错误）。

## 3. 使用示例

以生成一个 **指定日期** 的密钥为例，假设：
* 服务器公网 IP: `47.116.165.228`
* 端口: `3008`
* 管理员口令: `ADMIN123`
* 目标日期: `20250621`

```bash
curl "http://47.116.165.228:3008/admin/new?token=ADMIN123&type=D&date=20250621"
# 输出示例
# D-20250621-5z8x-1fe3c2a1
```

生成一次性密钥：
```bash
curl "http://47.116.165.228:3008/admin/new?token=ADMIN123&type=O"
```

生成 5 天有效密钥：
```bash
curl "http://47.116.165.228:3008/admin/new?token=ADMIN123&type=N5"
```

## 4. 常见问题

### 4.1 404 / 502 访问不到接口？
* 服务可能未启动：`pm2 list` 或 `ps -ef | grep node` 检查。
* 防火墙未放行端口：确认安全组规则中已允许 TCP 3008。

### 4.2 返回 401 no auth？
* `token` 参数错误。请与服务器实际 `ADMIN_SECRET` 保持一致。

### 4.3 如何注销密钥？
* 当前示例仅支持内存中的 `VALID_KEYS` 列表。可通过修改代码或接入数据库实现禁用逻辑。

---

### 更新记录
* 2025-06-21  首次撰写 